if(!Array.prototype.filter){Array.prototype.filter=function(fun){"use strict";if(this===void 0||this===null){throw new TypeError}var t=Object(this);var len=t.length>>>0;if(typeof fun!=="function"){throw new TypeError}var res=[];var thisArg=arguments.length>=2?arguments[1]:void 0;for(var i=0;i<len;i++){if(i in t){var val=t[i];if(fun.call(thisArg,val,i,t)){res.push(val)}}}return res}}if(!String.prototype.startsWith){String.prototype.startsWith=function(searchString,position){position=position||0;return this.indexOf(searchString,position)===position}}function CmdStack(id,max_size){"use strict";var instance_id=id,cur=0,arr=[];if(typeof id!=="string"){throw"Stack error: id should be a string."}if(typeof max_size!=="number"){throw"Stack error: max_size should be a number."}function setArray(arr){localStorage["cmd_stack_"+instance_id]=JSON.stringify(arr)}function getArray(){if(!localStorage["cmd_stack_"+instance_id]){arr=[];setArray(arr)}try{arr=JSON.parse(localStorage["cmd_stack_"+instance_id])}catch(err){return[]}return arr}function push(cmd){arr=getArray();if(cmd===arr[arr.length-1]){return false}arr.push(cmd);while(arr.length>max_size){arr.shift()}cur=arr.length;setArray(arr)}function prev(){cur-=1;if(cur<0){cur=0}return arr[cur]}function next(){cur=cur+1;if(cur===arr.length){return""}if(cur>arr.length-1){cur=arr.length-1}return arr[cur]}function reset(){arr=getArray();cur=arr.length}function isEmpty(){arr=getArray();return arr.length===0}function empty(){arr=undefined;localStorage.clear();reset()}function getCur(){return cur}function getArr(){return arr}function getSize(){return arr.size}return{push:push,prev:prev,next:next,reset:reset,isEmpty:isEmpty,empty:empty,getCur:getCur,getArr:getArr,getSize:getSize}}(function(root,factory){if(typeof define==="function"&&define.amd){define(factory)}else if(typeof exports==="object"){module.exports=factory()}else{root.Cmd=factory()}})(this,function(){"use strict";var Cmd=function(user_config){this.keys_array=[9,13,38,40,27],this.style="dark",this.popup=false,this.prompt_str="$ ",this.speech_synth_support="speechSynthesis"in window&&typeof SpeechSynthesisUtterance!=="undefined",this.options={busy_text:"Communicating...",external_processor:function(){},filedrop_enabled:false,file_upload_url:"ajax/uploadfile.php",history_id:"cmd_history",remote_cmd_list_url:"",selector:"#cmd",tabcomplete_url:"",talk:false,unknown_cmd:"Unrecognised command",typewriter_time:32},this.voices=false;this.remote_commands=[];this.all_commands=[];this.local_commands=["clear","clr","cls","clearhistory","invert","shh","talk"];this.autocompletion_attempted=false;$.extend(this.options,user_config);if(this.options.remote_cmd_list_url){$.ajax({url:this.options.remote_cmd_list_url,context:this,dataType:"json",method:"GET",success:function(data){this.remote_commands=data;this.all_commands=$.merge(this.remote_commands,this.local_commands)}})}else{this.all_commands=this.local_commands}if(!$(this.options.selector).length){throw"Cmd err: Invalid selector."}this.cmd_stack=new CmdStack(this.options.history_id,30);if(this.cmd_stack.isEmpty()){this.cmd_stack.push("secretmagicword!")}this.cmd_stack.reset();this.setupDOM();this.input.focus()};Cmd.prototype.setupDOM=function(){this.wrapper=$(this.options.selector).addClass("cmd-interface");this.container=$("<div/>").addClass("cmd-container").appendTo(this.wrapper);if(this.options.filedrop_enabled){setupFiledrop()}this.clearScreen();$(this.options.selector).on("click",$.proxy(this.focusOnInput,this));$(window).resize($.proxy(this.resizeInput,this));this.wrapper.keydown($.proxy(this.handleKeyDown,this));this.wrapper.keyup($.proxy(this.handleKeyUp,this));this.wrapper.keydown($.proxy(this.handleKeyPress,this))};Cmd.prototype.showInputType=function(input_type){switch(input_type){case"password":this.input=$("<input/>").attr("type","password").attr("maxlength",512).addClass("cmd-in");break;case"textarea":this.input=$("<textarea/>").addClass("cmd-in");break;default:this.input=$("<input/>").attr("type","text").attr("maxlength",512).addClass("cmd-in")}this.container.children(".cmd-in").remove();this.input.appendTo(this.container).attr("title","Chimpcom input");this.focusOnInput()};Cmd.prototype.typewriter=function(elem,str){elem=elem.first()[0];str=elem.innerHTML+str;var i=elem.innerHTML.length,isTag,text;var type=$.proxy(function(){text=str.slice(0,++i);if(text===str)return;elem.innerHTML=text;var char=text.slice(-1);if(char==="<")isTag=true;if(char===">")isTag=false;if(isTag)return type();console.log(this);setTimeout(type,this.options.typewriter_time)},this);type()};Cmd.prototype.displayOutput=function(cmd_in,cmd_out){if(typeof cmd_in!=="string"){cmd_in="Error: invalid cmd_in returned."}if(typeof cmd_out!=="string"){cmd_out="Error: invalid cmd_out returned."}cmd_in=cmd_in.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");if(this.output.html()){this.output.append("<br>")}this.output.append('<span class="prompt">'+this.prompt_str+"</span> "+'<span class="grey_text">'+cmd_in+"</span><br>");if(this.options.typewriter_time>0&&cmd_out.length<200){this.typewriter(this.output,cmd_out+"<br>")}else{this.output.append(cmd_out)}if(this.options.talk){this.speakOutput(cmd_out)}this.cmd_stack.reset();this.input.val("").removeAttr("disabled");this.enableInput();this.focusOnInput()};Cmd.prototype.setPrompt=function(new_prompt){if(typeof new_prompt!=="string"){throw"Cmd error: invalid prompt string."}this.prompt_str=new_prompt;this.prompt_elem.html(this.prompt_str)};Cmd.prototype.resetDropzone=function(){dropzone.css("display","none")};Cmd.prototype.setupFiledrop=function(){this.dropzone=$("<div/>").addClass("dropzone").appendTo(wrapper).filedrop({url:this.options.file_upload_url,paramname:"dropfile",maxfiles:10,maxfilesize:2,error:function(err,file){switch(err){case"BrowserNotSupported":alert("Your browser does not support html5 drag and drop.");break;case"TooManyFiles":this.displayOutput("[File Upload]","Too many files!");this.resetDropzone();break;case"FileTooLarge":this.displayOutput("[File Upload]","File too big!");this.resetDropzone();break;default:this.displayOutput("[File Upload]","Fail D:");this.resetDropzone();break}},dragOver:function(){this.dropzone.css("display","block")},dragLeave:function(){this.resetDropzone()},docOver:function(){this.dropzone.css("display","block")},docLeave:function(){this.resetDropzone()},drop:function(){this.dropzone.append("<br>File dropped.")},uploadStarted:function(i,file,len){this.dropzone.append("<br>Upload started...")},uploadFinished:function(i,file,response,time){if(response.error!==""){upload_error=response.error}this.dropzone.append("<br>Upload finished! "+response.result)},progressUpdated:function(i,file,progress){this.dropzone.append("<br>File uploading...")},speedUpdated:function(i,file,speed){this.dropzone.append("<br>Upload speed: "+speed)},afterAll:function(){if(upload_error!==""){this.displayOutput("[File Upload]","Error: "+upload_error)}else{this.displayOutput("[File Upload]","Success!")}upload_error="";this.dropzone.css("display","none");this.resetDropzone()}})};Cmd.prototype.invert=function(){this.wrapper.toggleClass("inverted")};Cmd.prototype.handleInput=function(input_str){var cmd_array=input_str.split(" ");switch(cmd_array[0]){case"":this.displayOutput("","");break;case"clear":case"cls":case"clr":this.clearScreen();break;case"clearhistory":this.cmd_stack.empty();this.cmd_stack.reset();this.displayOutput(input_str,"Command history cleared. ");break;case"easteregg":this.displayOutput(input_str,"You found a secret");break;case"invert":this.invert();this.displayOutput(input_str,"Shazam.");break;case"shh":if(this.options.talk){window.speechSynthesis.cancel();this.options.talk=false;this.displayOutput(input_str,"Speech stopped. Talk mode is still enabled. Type TALK to disable talk mode.");this.options.talk=true}else{this.displayOutput(input_str,"Ok.")}break;case"talk":if(!this.speech_synth_support){this.displayOutput(input_str,"You browser doesn't support speech synthesis.");return false}this.options.talk=!this.options.talk;this.displayOutput(input_str,this.options.talk?"Talk mode enabled.":"Talk mode disabled.");break;default:if(typeof this.options.external_processor!=="function"){this.displayOutput(input_str,this.options.unknown_cmd);return false}var result=this.options.external_processor(input_str,this);switch(typeof result){case"boolean":if(!result){this.displayOutput(input_str,this.options.unknown_cmd)}break;case"object":this.handleResponse(result);break;case"string":this.displayOutput(input_str,result);break;default:this.displayOutput(input_str,this.options.unknown_cmd)}}};Cmd.prototype.handleResponse=function(res){if(res.redirect!==undefined){document.location.href=res.redirect}if(res.openWindow!==undefined){window.open(res.openWindow,"_blank",res.openWindowSpecs)}if(res.log!==undefined&&res.log!==""){console.log(res.log)}if(res.hide_output===true){res.cmd_in=new Array(cmd_in.length).join("*")}if(res.show_pass===true){this.showInputType("password")}else{this.showInputType()}this.displayOutput(res.cmd_in,res.cmd_out);if(res.cmd_fill!==""){this.wrapper.children(".cmd-container").children(".cmd-in").first().val(res.cmd_fill)}this.activateAutofills()};Cmd.prototype.handleKeyPress=function(e){var keyCode=e.keyCode||e.which,input_str=this.input.val(),autocompletions;if(keyCode===9){this.tabComplete(input_str)}else{this.autocompletion_attempted=false;if(this.autocomplete_ajax){this.autocomplete_ajax.abort()}if(keyCode===13){if(this.input.attr("disabled")){return false}if(e.ctrlKey){this.cmd_stack.push(input_str);this.goToURL(input_str)}else{this.disableInput();if(this.input.get(0).type==="text"){this.cmd_stack.push(input_str)}this.handleInput(input_str)}}else if(keyCode===38){if(input_str!==""&&this.cmd_stack.cur===this.cmd_stack.getSize()-1){this.cmd_stack.push(input_str)}this.input.val(this.cmd_stack.prev())}else if(keyCode===40){this.input.val(this.cmd_stack.next())}else if(keyCode===27){if(this.container.css("opacity")>.5){this.container.animate({opacity:0},300)}else{this.container.animate({opacity:1},300)}}}};Cmd.prototype.handleKeyUp=function(e){var key=e.which;if($.inArray(key,this.keys_array)>-1){e.preventDefault();return false}return true};Cmd.prototype.handleKeyDown=function(e){var key=e.which;if($.inArray(key,this.keys_array)>-1){e.preventDefault();return false}return true};Cmd.prototype.tabComplete=function(str){if(str.indexOf(" ")!==-1){if(this.options.tabcomplete_url){if(this.autocomplete_ajax){this.autocomplete_ajax.abort()}this.autocomplete_ajax=$.ajax({url:this.options.tabcomplete_url,context:this,dataType:"json",data:{cmd_in:str},success:function(data){if(data){this.input.val(data)}}})}this.autocompletion_attempted=false;return}var autocompletions=this.all_commands.filter(function(value){return value.startsWith(str)});if(autocompletions.length===0){return false}else if(autocompletions.length===1){this.input.val(autocompletions[0])}else{if(this.autocompletion_attempted){this.displayOutput(str,autocompletions.join(", "));this.autocompletion_attempted=false;this.input.val(str);return}else{this.autocompletion_attempted=true}}};Cmd.prototype.goToURL=function(url){if(url.substr(0,4)!=="http"&&url.substr(0,2)!=="//"){url="http://"+url}if(popup){window.open(url,"_blank");window.focus()}else{if(top.location!==location){top.location.href=document.location.href}location.href=url}};Cmd.prototype.focusOnInput=function(){var cmd_width;$(this.options.selector).scrollTop($(this.options.selector)[0].scrollHeight);this.input.focus()};Cmd.prototype.resizeInput=function(){var cmd_width=this.wrapper.width()-this.wrapper.find(".main-prompt").first().width()-45;this.input.focus().css("width",cmd_width)};Cmd.prototype.clearScreen=function(){this.container.empty();this.output=$("<div/>").addClass("cmd-output").appendTo(this.container);this.prompt_elem=$("<span/>").addClass("main-prompt").addClass("prompt").html(this.prompt_str).appendTo(this.container);this.input=$("<input/>").addClass("cmd-in").attr("type","text").attr("maxlength",512).appendTo(this.container);this.showInputType();this.input.val("")};Cmd.prototype.activateAutofills=function(){this.wrapper.find("[data-type=autofill]").on("click",function(){this.input.val($(this).data("autofill"))})};Cmd.prototype.disableInput=function(){this.input.attr("disabled",true).val(this.options.busy_text)};Cmd.prototype.enableInput=function(){this.input.removeAttr("disabled").val("")};Cmd.prototype.speakOutput=function(output){var msg=new SpeechSynthesisUtterance;msg.volume=1;msg.rate=1;msg.pitch=2;msg.lang="en-UK";msg.text=output;window.speechSynthesis.speak(msg)};return Cmd});
